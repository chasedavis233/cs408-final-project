<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BiteRec • Profile</title>
  <link rel="icon" href="logo.svg" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />

  <!-- page-scoped styles -->
  <style>
    .profile-page .profile-head {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }

    .profile-page .avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: .3px;
      color: #0b0f13;
      background: #fff;
      border: 1px solid var(--chrome);
      font-size: 1.2rem;
    }

    .profile-page .grid-2 {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
    }

    .profile-page .card h3 {
      margin: .25rem 0 .6rem;
    }

    .profile-page .form {
      display: grid;
      gap: 12px;
    }

    .profile-page .field {
      display: grid;
      gap: 6px;
    }

    .profile-page .field label {
      font-weight: 700;
      font-size: .9rem;
    }

    .profile-page .field input[type="text"],
    .profile-page .field input[type="email"],
    .profile-page .field input[type="number"] {
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid var(--chrome);
      border-radius: 12px;
      padding: .7rem .8rem;
      font: inherit;
    }

    .profile-page .field input::placeholder {
      color: var(--muted);
    }

    .profile-page .switch-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .profile-page .switch-row input[type="checkbox"] {
      width: 42px;
      height: 22px;
      accent-color: var(--brand);
    }

    .profile-page .switch-row label {
      font-size: .9rem;
    }

    .profile-page .stat-cards {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 8px;
    }

    .profile-page .stat-card {
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--chrome);
      background: rgba(255,255,255,.04);
    }

    .profile-page .stat-card .label {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .profile-page .stat-card .num {
      font-size: 1.7rem;
      font-weight: 900;
      color: var(--brand);
    }

    .profile-page .muter {
      color: var(--muted);
      font-size: .9rem;
    }

    .profile-page .danger {
      border-color: #f97373;
      color: #fecaca;
    }

    @media (max-width: 900px) {
      .profile-page .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>

<body data-theme="obsidian" class="profile-page">
  <!-- NAV -->
  <header class="site-header">
    <div class="nav-shell glass-nav">
      <nav class="nav container" aria-label="Primary">
        <a class="brand" href="index.html" aria-label="BiteRec home">
          <img class="brand-mark" src="logo.svg" alt="BiteRec logo" width="22" height="22" />
          <span class="brand-word">BiteRec</span>
        </a>
        <ul class="navlinks">
          <li>
            <a class="navlink" data-nav="explore" href="explore.html">
              <svg class="nav-ico" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M11 4a7 7 0 1 1-4.95 2.05A6.97 6.97 0 0 1 11 4m0-2a9 9 0 1 0 5.657 15.9l3.72 3.72 1.415-1.414-3.72-3.72A9 9 0 0 0 11 2Z"/>
              </svg>
              <span>Explore</span>
            </a>
          </li>
          <li>
            <a class="navlink" data-nav="lists" href="lists.html">
              <svg class="nav-ico" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M7 5h14v2H7V5Zm0 6h14v2H7v-2Zm0 6h14v2H7v-2ZM3 5h2v2H3V5Zm0 6h2v2H3v-2Zm0 6h2v2H3v-2Z"/>
              </svg>
              <span>My Lists</span>
            </a>
          </li>
          <li>
            <a class="navlink navlink-icon is-active" data-nav="profile" href="profile.html" aria-label="Profile">
              <svg class="nav-ico" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/>
              </svg>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container" id="main" tabindex="-1">
    <div class="page-frame">
      <section class="profile">
        <!-- Header -->
        <div class="profile-head">
          <div class="avatar" id="avatarBox">BR</div>
          <div>
            <h1 class="display" id="greeting">Your Profile</h1>
            <p class="muter">
              Personalize BiteRec and see quick stats for this browser. No real account yet –
              everything here stays on your device.
            </p>
          </div>
        </div>

        <div class="grid-2">
          <!-- LEFT: local settings -->
          <article class="card">
            <h3>Preferences</h3>
            <div class="form">
              <div class="field">
                <label for="displayName">Display name</label>
                <input id="displayName" type="text" placeholder="Your name" />
              </div>

              <div class="field">
                <label for="avatarText">Avatar initials</label>
                <input id="avatarText" type="text" maxlength="3" placeholder="e.g., JD" />
              </div>

              <div class="field">
                <label for="defaultZip">Default ZIP code</label>
                <input id="defaultZip" type="text" inputmode="numeric" placeholder="e.g., 83702" />
                <p class="muter">Used to pre-fill the Explore search bar.</p>
              </div>

              <div class="switch-row">
                <input id="confirmDelete" type="checkbox" />
                <label for="confirmDelete">Ask for confirmation before removing from lists</label>
              </div>

              <div>
                <button class="btn btn--primary" id="btnSave">Save Settings</button>
              </div>
            </div>
          </article>

          <!-- RIGHT: stats + data tools -->
          <aside class="card">
            <h3>Quick Stats</h3>
            <div class="stat-cards">
              <div class="stat-card">
                <div class="label">Saved</div>
                <div class="num" id="statSaved">0</div>
              </div>
              <div class="stat-card">
                <div class="label">Tried</div>
                <div class="num" id="statTried">0</div>
              </div>
              <div class="stat-card">
                <div class="label">Favorites</div>
                <div class="num" id="statFavs">0</div>
              </div>
            </div>

            <h3>Data</h3>
            <div class="row" style="display:flex;flex-wrap:wrap;gap:10px;">
              <button class="btn btn--ghost brand-outline" id="btnExport">Export JSON</button>

              <label class="btn btn--ghost brand-outline" for="importFile" style="cursor:pointer;">
                Import JSON
              </label>
              <input id="importFile" type="file" accept="application/json" hidden />
            </div>

            <div class="row" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;">
              <button class="btn btn--ghost brand-outline danger" id="btnErase">
                Erase Local Data
              </button>
            </div>

            <p class="muter" style="margin-top:8px;">
              Profile settings are stored locally. Restaurant data is saved to AWS via the
              demo Lambda + DynamoDB, but there’s no sign-in or email yet – everything here
              is free-tier friendly.
            </p>
          </aside>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container"><small>© 2025 BiteRec</small></div>
  </footer>

  <!-- existing globals (BiteRecAPI, nav highlighting, theme, etc.) -->
  <script src="js/api.js"></script>
  <script type="module" src="js/main.js"></script>

  <!-- profile page logic -->
  <script>
    (function () {
      const PROFILE_KEY = "biterec-profile";
      const ZIP_KEY = "biterec-default-zip";

      const api = window.BiteRecAPI || {};
      const { fetchRestaurants, saveRestaurant } = api;

      // ----- DOM helpers -----
      const $ = (id) => document.getElementById(id);

      const displayNameEl  = $("displayName");
      const avatarTextEl   = $("avatarText");
      const avatarBoxEl    = $("avatarBox");
      const defaultZipEl   = $("defaultZip");
      const confirmDeleteEl= $("confirmDelete");
      const greetingEl     = $("greeting");

      const statSavedEl = $("statSaved");
      const statTriedEl = $("statTried");
      const statFavsEl  = $("statFavs");

      const btnSave    = $("btnSave");
      const btnExport  = $("btnExport");
      const btnErase   = $("btnErase");
      const importFile = $("importFile");

      // ----- Profile model in localStorage -----
      function loadProfile() {
        try {
          const raw = localStorage.getItem(PROFILE_KEY);
          if (!raw) {
            return {
              displayName: "",
              initials: "BR",
              defaultZip: "83702",
              confirmDelete: true,
            };
          }
          const parsed = JSON.parse(raw);
          return {
            displayName: parsed.displayName || "",
            initials: (parsed.initials || "BR").toUpperCase(),
            defaultZip: parsed.defaultZip || "83702",
            confirmDelete:
              typeof parsed.confirmDelete === "boolean"
                ? parsed.confirmDelete
                : true,
          };
        } catch {
          return {
            displayName: "",
            initials: "BR",
            defaultZip: "83702",
            confirmDelete: true,
          };
        }
      }

      function saveProfile(profile) {
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
        // also expose default zip for Explore page
        localStorage.setItem(ZIP_KEY, profile.defaultZip || "83702");
      }

      let profile = loadProfile();

      function paintProfile() {
        displayNameEl.value = profile.displayName || "";
        avatarTextEl.value  = profile.initials || "";
        avatarBoxEl.textContent = (profile.initials || "BR").toUpperCase();
        defaultZipEl.value  = profile.defaultZip || "";
        confirmDeleteEl.checked = !!profile.confirmDelete;

        if (profile.displayName) {
          greetingEl.textContent = `${profile.displayName}'s Profile`;
        } else {
          greetingEl.textContent = "Your Profile";
        }
      }

      // live avatar preview
      avatarTextEl.addEventListener("input", () => {
        const text = (avatarTextEl.value || "BR").toUpperCase();
        avatarBoxEl.textContent = text;
      });

      // Save button
      btnSave.addEventListener("click", () => {
        profile.displayName = displayNameEl.value.trim();
        profile.initials = (avatarTextEl.value.trim() || "BR").toUpperCase();
        profile.defaultZip = defaultZipEl.value.trim() || "83702";
        profile.confirmDelete = !!confirmDeleteEl.checked;

        saveProfile(profile);
        paintProfile();
      });

      // ----- Stats: load restaurants from backend and compute counts -----
      let cachedRestaurants = [];

      function getProfileId() {
        if (
          window.BiteRecStore &&
          typeof window.BiteRecStore.getActiveProfileId === "function"
        ) {
          return window.BiteRecStore.getActiveProfileId();
        }
        return "household-main";
      }

      async function loadStats() {
        if (!fetchRestaurants) {
          console.warn("BiteRecAPI.fetchRestaurants is not available");
          return;
        }
        const profileId = getProfileId();
        try {
          const raw = await fetchRestaurants(profileId, {});
          const list =
            Array.isArray(raw) ? raw :
            Array.isArray(raw.restaurants) ? raw.restaurants :
            Array.isArray(raw.items) ? raw.items :
            Array.isArray(raw.data) ? raw.data : [];

          cachedRestaurants = list;

          const saved = list.length;
          const tried = list.filter((r) => (r.status || "").toLowerCase() === "tried").length;
          const favs  = list.filter((r) => r.isFavorite || r.favorite).length;

          statSavedEl.textContent = saved;
          statTriedEl.textContent = tried;
          statFavsEl.textContent  = favs;
        } catch (err) {
          console.error("Failed to load stats", err);
        }
      }

      // ----- Export / Import / Erase -----
      btnExport.addEventListener("click", () => {
        const payload = {
          profile,
          restaurants: cachedRestaurants,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "biterec-profile-export.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      importFile.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const imported = JSON.parse(text);

          if (imported.profile) {
            profile = {
              ...loadProfile(),
              ...imported.profile,
            };
            saveProfile(profile);
            paintProfile();
          }

          if (imported.restaurants && saveRestaurant && Array.isArray(imported.restaurants)) {
            const profileId = getProfileId();
            // simple sequential save to avoid hammering Lambda
            for (const r of imported.restaurants) {
              const payload = { ...r };
              await saveRestaurant(profileId, payload);
            }
            await loadStats();
          }

          alert("Import complete.");
        } catch (err) {
          console.error("Import failed", err);
          alert("Import failed. Make sure this is a BiteRec export JSON file.");
        } finally {
          e.target.value = "";
        }
      });

      btnErase.addEventListener("click", () => {
        if (
          !confirm(
            "Erase all local BiteRec profile settings on this browser? Your restaurant data in AWS will not be deleted."
          )
        ) {
          return;
        }
        localStorage.removeItem(PROFILE_KEY);
        localStorage.removeItem(ZIP_KEY);
        profile = loadProfile();
        saveProfile(profile);
        paintProfile();
        alert("Local profile settings cleared.");
      });

      // ----- Init -----
      paintProfile();
      loadStats();
    })();
  </script>
</body>
</html>
